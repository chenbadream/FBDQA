# FBDQA第三次课程


# 01 资本资产定价模型CAPM
## CAPM Model
$r_p=\beta _p\cdot r_m+\alpha _p+\epsilon _p$
- $r_p$：投资组合超额收益率
- $r_m$：同期市场超额收益率
- $\beta _p$：投资组合P相对于市场M的beta系数
- $\alpha _p$：反映了组合P相对于市场M的超额收益能力
- $\epsilon _p$：一个期望为0随机项

已知$\beta _p$, $r_p=\beta _p\cdot r_m+\theta_p$
CAPM的理论期望$E(\theta _p)=0$
$\implies$ 收益率只和$\beta$有关

# 02 APT（套利定价理论）
APT给超额收益率设定了一个多因子模型

$$
r_n = \sum_{k=1}^{K} X_{nk} \cdot b_k + u_n \\
$$

其中：
- $X_{nk}$：股票n对因子k的暴露度（exposure of stock n to factor k），暴露度经常被称为因子载荷（factor loading）。为了能够在实践中使用，假设暴露度可以在收益率考察周期前获知；
- $b_k$：因子k的因子收益率（factor return for factor k）。因子收益率或是在考察期末被归因到因子上，或是直接在考察期上被观测到；
- $u_n$：股票n的特异收益率（stock n’s specific return）。即收益率中不能被因子解释的部分。

### APT的主要结论
- 在均衡状态下，任何资产的期望收益率都可以表示为一系列宏观经济因素的线性组合。
- 资产的期望收益率与这些宏观经济因素的风险暴露成正比。

# 03 因子投资简介
## 因子的来历
+ GDP,通货膨胀，企业利润等。因子的变动导致了证券汇报的变动。

+ 尽可能以少的因子变化解释尽可能多的证券回报差异

## 因子投资的发展
- 单因子:
  -- CAPM Market Beta
  -- 市场对风险和回报的认识是单一的
- 多因子:
  -- Fama & French 3 factors, Carhart 4 factors, FF 5 factors
  -- 市场对风险和回报由多个维度的认识
- 市场异常回报:
  -- 无法被其他因子所解释
  -- Value, Momentum, Low Beta, Quality, Size
- 因子投资:
  -- 为投资人提供因子的回报和敞口
  -- 有单因子基金，也有多因子组合

## 因子的特点
+ 每种因子都有其周期性，都不可能在短时间内跑赢大盘，选择哪个因子要域投资人的风险承受能力匹配。

+ 只有在可靠的投资框架内坚持自己的投资理念，与自己的认知缺陷抗衡，投资人才有可能在较长的投资期限上战胜大盘。

## 因子检验的一般方法：一维零投资组合检验
- 第一步:选定研究因子，并使用每一时期的该因子敞口对股票进行排序，对排序结果进行五(或十)分位划割
- 第二步:在第一个五分位里构造相同权重的股票组合，同时在最后一个五分位里相同权重的股票组合，第一个五分位是根据该因子排序的前1/5的股票，最后一个五分位是根据该因子排序的最后1/5的股票
- 第三步:计算两个股票组合的月度收益，并计算两个组合收益率的差值，该差值即为零投资组合的收益。这里的零投资组合是通过买进最顶层划分中的投资组合并卖空最底层划分的投资组合得到，它被称为零投资组合是因为从理论上讲构造该投资组合不需要资本。
- 第四步:在计算过零投资组合的收益后，我们进行统计检验，以考察等权重股票组合与零投资组合收益是否存在显著不同。

# 04获取数据与因子构建

## 多因子策略整体框架
- 获取数据
- 构建因子
- 因子预处理
- 单因子测试
- 多因子交互分析
- 选择因子
- 构建多因子模型
- 回测，模型评估

## 数据与因子获取
影响股票收益的风险因子:
- 市场风险：所有股票都会收到市场整体供需的影响而出现同涨同跌的现象，及牛市和熊市
- 行业风险：从事相同或者相似业务公司的股票，由于受到产业景气周期影响，或者共同的产业政策冲击，在市场上表现出较高的相关性
- 风格风险：剔除市场风险和行业风险之后，股票市场结构表现在一定的时期会呈现出很强烈的风格特征。比如小市值股票表现更优的小市值风格，前期收益低的股票近期收益更高的反转风格，成长性高的股票表现更好的成长风格。


### 大类风格因子举例
1. 估值因子
2. 成长因子
3. 一致预期因子
4. 反转/动量因子
5. 财务质量因子
6. 杠杆因子
7. 规模因子
8. 波动率因子
9. 技术因子

## 因子库的搭建与选取
因子库的搭建：
- 自己搭建、自己进行因子的计算
- 可以参考华泰101、光大因子测试全集、WorldQuant101......
- 接口：Wind、WindQuant API、JQData......
因子的选取规则：
- 既要有相对高频的交易类因子，也要有相对低频的财务因子，因子的选择尽量覆盖不同属性。

# 05 因子预处理
## 数据清洗与数据预处理
### 异常值处理
使用中位数极值法(MAD)修正异常值，MAD为序列$|X_i-X_m|$的中位数

$$
\tilde{x}_i=
\begin{cases}
    x_M+n*D_{MAD},&\text{if }x_i\gt x_M+n*D_{MAD} \\
    x_M-n*D_{MAD},&\text{if }x_i\lt x_M-n*D_{MAD} \\
    x_i ,&\text{else}\\
\end{cases}\\
$$
### 缺失值处理
缺失数量太多（大于20%），因子直接剔除；否则，行业均值/中位数填充；可比公司替代法、历史数据替代法（延用上期因子值）

### 中性化处理
在验证风格因子有效性时，必须考虑市场因子和行业因子的影响，将市场因子和行业因子同时纳入模型。
中性化因子：因子值对流通市值对数和一级行业哑变量进行回归的残差。
### 标准化处理
为了保证代表不同指标的因子值相互之间可比，需要对因子进行标准化，常见的因子标准化方法包括：Z 值标准化（Z-Score），Rank 标准化，风格标准化等等。

### 行业市值中性化
在截面上对于所有个股的因子值进行如下的回归方程处理：
其中，$F_i$为股票 i 的因子值，$MktVal_i$为总市值，$Ind_j$, i为股票 i 对应申万一级行业 j 的虚拟变量，回归处理后的残差项作为风格中性化处理后的因子。
有的单因子存在行业和市值偏好，剔除其影响后选出股票更分散，效果可能更好。
$$
F_i=\beta_M \cdot \ln(MktVal_i)+\sum_{j=1}^N \beta_{i,j}\cdot Ind_{j,i}+\epsilon_i \\
$$

### 因子值&因子秩
首先将因子载荷原始值转换为排序值，然后再进行处理。

使用因子秩的好处：
- 只关注原始序列的序关系，在做相关性分析时也只是关注排序之间的相关性，对原始变量的分布不作要求，属于非参数统计方法，适用范围相对广。
- 行业中性化、市值中性化不需要了。
- 异常值处理较方便：设定范围，比如300个数据，设定[10,290]。

# 06 单因子测试体系
## 因子IC测试
IC：个股第T期在因子k上的暴露度与T+1期的收益率的相关系数。

RankIC：个股第T期在因子k上的暴露度的排名与T+1期的收益率的排名的相关系数。

当得到各因子IC值序列后，计算如下指标：
1. IC均值及绝对值均值：判断因子有效性；
2. IC值标准差：判断因子稳定性；
3. IC值大于0的占比：判断因子效果的一致性；
4. IC 显著比率： IC 大于（或小于）某显著水平，如 0.02 的比率。
5. 年化IC_IR：判断因子兼顾稳定性下的预测能力。理想的选股因子 IC 均值大，预测能力强；另一方面 IC 波动率低，因子收益稳定波动较小，ICIR 指标将这两者做了有机的结合。

- **ICIR**：

$$
ICIR=\frac{mean(IC)}{std(IC)} \cdot \sqrt{12} \\
$$

### *因子收益率截面回归
### *因子收益率序列t检验
### **分位数组合测试**
1. 行业中性组合：选取一个基准组合，将所有个股在各个行业内按照得分进行排序，每个行业内按得分从高到低分成N个组合，每个行业内的每个组合中股票按流通市值配比，然后将各行业的N个组合中序数相同的组合结合在一起（最后一共形成N个组合），组合内行业间权重按沪深300配比。
2. 全市场分组：直接在全股票池中不分行业按得分高低分成N个组合，每个组合中的股票等权配比或按流通市值配比。

# 07 多因子研究框架
## 多因子相关性分析的一般方法
- 相关性检验
  - 因子暴露相关性
  - 因子秩相关性
  - 因子收益相关性
  - IC值相关性
- 因子筛选/合成
  - 根据因子本身的有效性进行排序，挑选最有效的因子进行保留，删除其他因子；
  - 进行因子合成：等权加权，因子收益加权，PCA
## 因子正交化处理
### 因子正交化处理的必要性
1. 传统的多因子模型往往采用 IC 加权、IR 加权或 IC_IR 加权的方式来确定各个因子在模型中的权重，但以上加权方式均存在一个较大的缺陷，即因子间的共线性会导致最终的多因子组合对某个风格因子重复暴露。一旦市场出现某个风格上的显著切换，该风格因子上的重复暴露会导致组合表现受到严重影响。
2. 选股因子间的截面相关性较不稳定，仅限于某个时点。
### 因子正交化处理
- 规范正交
- 主成分分析
- 对称正交
- 施密特正交
## 打分法多因子选股模型
打分法，亦即因子加权法。是指在已经选出若干能够对股票收益产生预测作用的因子、并获得全体股票的所有因子值的基础上，按照一定的权重将每个股票的各个因子得分相加从而得到该股票的最终得分。
在得到总分之后，我们可以按照得分对股票进行排序、筛选，从而进一步构造投资组合。
### 核心：因子加权
- 等权重法
- 复合因子法
- IC或IC_IR加权法
- 动态最优权重法

## 回归法多因子选股模型
- 时序回归
- 截面回归
- Fama-MacBeth回归
## 投资组合构建
- 模型参数
  - 时间序列
  - 组合股票数量
  - 回测区间
  - 调仓频率
- 投资组合构建
  - 股票池
  - 股票组合赋权
  - 组合限制
## 模型指标评估
- 年化收益率
- 收益波动率
- 信息比/夏普
- Alpha
- 最大回撤
## 组合绩效归因
Barra模型
## 传统多因子模型的改进空间
存在缺陷：
- 难以应对因子的失效和转向
- 难以刻画因子之间的非线性关系
- 如何将最大回撤限制在可控范围内（3%）

方法：
- 投资组合优化
- 机器学习
- 因子择时